{% extends 'base/base.html' %}
{% load static %}

{% block title %}Confirmar Reserva - ArenaPadel.club{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card reservation-card animate-slide-in">
                <div class="card-header bg-primary text-white py-3">
                    <h1 class="h4 mb-0">Confirmar Reserva</h1>
                </div>
                
                <div class="card-body">
                    <!-- Reservation Details -->
                    <div class="mb-4">
                        <h2 class="h5 mb-3">Detalles de la Reserva</h2>
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-volleyball-ball me-2"></i>Cancha</span>
                                <span class="fw-bold text-primary">{{ reservation.court.name }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="far fa-calendar me-2"></i>Fecha</span>
                                <span class="fw-bold">{{ reservation.start_time|date:"d/m/Y" }}</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="far fa-clock me-2"></i>Hora</span>
                                <span class="fw-bold">
                                    {{ reservation.start_time|time:"H:i" }} - {{ reservation.end_time|time:"H:i" }}
                                </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-hourglass-half me-2"></i>Duración</span>
                                <span class="fw-bold">{{ duration }} hora(s)</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-tag me-2"></i>Total</span>
                                <span class="fw-bold h4 mb-0 text-primary">${{ total }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="mb-4">
                        <h2 class="h5 mb-3">Método de Pago</h2>
                        <form id="payment-form" method="post" action="{% url 'process_payment' reservation.id %}" class="needs-validation" novalidate>
                            {% csrf_token %}
                            <input type="hidden" id="id_payment_method" name="payment_method" value="">

                            <div class="row g-3">
                                <!-- Credit Card -->
                                <div class="col-md-4">
                                    <div class="card payment-method h-100" data-method="stripe">
                                        <div class="card-body text-center py-4">
                                            <i class="fas fa-credit-card fa-2x mb-3 text-primary"></i>
                                            <h3 class="h6 mb-0">Tarjeta de Crédito</h3>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bank Transfer -->
                                <div class="col-md-4">
                                    <div class="card payment-method h-100" data-method="transfer">
                                        <div class="card-body text-center py-4">
                                            <i class="fas fa-university fa-2x mb-3 text-primary"></i>
                                            <h3 class="h6 mb-0">Transferencia Bancaria</h3>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cash -->
                                <div class="col-md-4">
                                    <div class="card payment-method h-100" data-method="cash">
                                        <div class="card-body text-center py-4">
                                            <i class="fas fa-money-bill fa-2x mb-3 text-primary"></i>
                                            <h3 class="h6 mb-0">Efectivo</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stripe Fields -->
                            <div id="stripe-fields" class="mt-4" style="display: none;">
                                <div id="card-element" class="form-control mb-3">
                                    <!-- Stripe Elements will be inserted here -->
                                </div>
                                <div id="card-errors" class="text-danger mb-3"></div>
                            </div>

                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary action-button w-100">
                                    <i class="fas fa-check-circle me-2"></i>Confirmar Reserva
                                </button>
                                <a href="{% url 'court_list' %}" class="btn btn-outline-secondary action-button w-100 mt-2">
                                    <i class="fas fa-times-circle me-2"></i>Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentMethods = document.querySelectorAll('.payment-method');
    const paymentMethodInput = document.getElementById('id_payment_method');
    const stripeFields = document.getElementById('stripe-fields');

    paymentMethods.forEach(method => {
        method.addEventListener('click', function() {
            // Remove active class from all methods
            paymentMethods.forEach(m => m.classList.remove('border-primary'));
            
            // Add active class to selected method
            this.classList.add('border-primary');
            
            // Set payment method value
            const methodValue = this.dataset.method;
            paymentMethodInput.value = methodValue;
            
            // Show/hide Stripe fields
            if (methodValue === 'stripe') {
                stripeFields.style.display = 'block';
            } else {
                stripeFields.style.display = 'none';
            }
        });
    });

    // Form validation
    const form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
        if (!paymentMethodInput.value) {
            event.preventDefault();
            showError('Por favor selecciona un método de pago');
        } else {
            // Show confirmation message
            const courtName = '{{ reservation.court.name }}';
            const date = '{{ reservation.start_time|date:"d/m/Y" }}';
            const time = '{{ reservation.start_time|time:"H:i" }}';
            showReservationConfirmation(courtName, date, time);
        }
    });
});
</script>
{% endblock %}
